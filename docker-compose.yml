version: "3.8"

services:
  # Frontend
  frontend:
    build: ./peer2prep-frontend
    container_name: peer2prep-frontend
    ports:
      - "5173:5173"
    env_file:
      - ./peer2prep-frontend/.env
    depends_on:
      - gateway
    networks:
      - gateway-network
    volumes:
      - ./peer2prep-frontend:/app
      - /app/node_modules
    restart: unless-stopped

  # API Gateway (nginx)
  gateway:
    image: nginx:latest
    container_name: api-gateway
    ports:
      - "8080:8080"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - user-service
      - matching-service
      - questions-service
      - collaboration-service
      - attempts-service
    networks:
      - gateway-network
    restart: unless-stopped

  # Message Broker (RabbitMQ)
  rabbitmq:
    image: rabbitmq:latest
    container_name: rabbitmq
    hostname: rabbitmq
    networks:
      - gateway-network
    healthcheck:
      test: rabbitmq-diagnostics check_port_connectivity
      interval: 30s
      timeout: 30s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  # User Service
  user-service:
    build: ./services/user
    container_name: user-service
    env_file:
      - ./services/user/.env
    depends_on:
      rabbitmq:
        condition: service_healthy
      user-db:
        condition: service_started
    networks:
      - gateway-network
      - user-db-network
    volumes:
      - ./services/user:/app
      - /app/node_modules
    restart: unless-stopped

  user-db:
    image: mongo:latest
    container_name: user-db
    volumes:
      - user_data:/data/db
    networks:
      - user-db-network
    restart: unless-stopped

  # Matching Service
  matching-service:
    build: ./services/matching
    container_name: matching-service
    env_file:
      - ./services/matching/.env
    depends_on:
      rabbitmq:
        condition: service_healthy
      matching-db:
        condition: service_started
    networks:
      - gateway-network
      - matching-db-network
    volumes:
      - ./services/matching:/app
      - /app/node_modules
    restart: unless-stopped

  matching-db:
    image: mongo:latest
    container_name: matching-db
    volumes:
      - matching_data:/data/db
    networks:
      - matching-db-network
    restart: unless-stopped

  # Questions Service
  questions-service:
    build: ./services/questions
    container_name: questions-service
    env_file:
      - ./services/questions/.env
    depends_on:
      rabbitmq:
        condition: service_healthy
      questions-db:
        condition: service_started
    networks:
      - gateway-network
      - questions-db-network
    volumes:
      - ./services/questions:/app
      - /app/node_modules
    restart: unless-stopped

  questions-db:
    image: mongo:latest
    container_name: questions-db
    volumes:
      - questions_data:/data/db
    networks:
      - questions-db-network
    restart: unless-stopped

  # Collaboration Service
  collaboration-service:
    build: ./services/collaboration
    container_name: collaboration-service
    env_file:
      - ./services/collaboration/.env
    depends_on:
      rabbitmq:
        condition: service_healthy
      collaboration-db:
        condition: service_started
    networks:
      - gateway-network
      - collaboration-db-network
    volumes:
      - ./services/collaboration:/app
      - /app/node_modules
    restart: unless-stopped

  collaboration-db:
    image: mongo:latest
    container_name: collaboration-db
    volumes:
      - collaboration_data:/data/db
    networks:
      - collaboration-db-network
    restart: unless-stopped

  # Attempts Service
  attempts-service:
    build: ./services/attempts
    container_name: attempts-service
    env_file:
      - ./services/attempts/.env
    depends_on:
      rabbitmq:
        condition: service_healthy
      attempts-db:
        condition: service_started
    networks:
      - gateway-network
      - attempts-db-network
    volumes:
      - ./services/attempts:/app
      - /app/node_modules
    restart: unless-stopped

  attempts-db:
    image: mongo:latest
    container_name: attempts-db
    volumes:
      - attempts_data:/data/db
    networks:
      - attempts-db-network
    restart: unless-stopped

  # Redis
  redis:
    image: redis:latest
    container_name: redis-container
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - gateway-network
    command: >
      redis-server --appendonly yes
        --user user on >password ~* +@all

volumes:
  user_data:
  matching_data:
  questions_data:
  collaboration_data:
  attempts_data:
  redis_data:

networks:
  gateway-network:
    driver: bridge
  user-db-network:
    driver: bridge
  matching-db-network:
    driver: bridge
  questions-db-network:
    driver: bridge
  collaboration-db-network:
    driver: bridge
  attempts-db-network:
    driver: bridge